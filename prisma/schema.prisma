generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & ORGANIZATION
// ============================================

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  fullName  String
  gender    String
  status    String   // PENDING | ACTIVE | INACTIVE
  role      String   // EMPLOYEE | DEPARTMENT_HEAD | HR | DIRECTOR
  hireDate  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  managedDepartments    Department[]           @relation("DepartmentManager")
  departmentEmployees   DepartmentEmployee[]
  leaveRequestsCreated  LeaveRequest[]         @relation("LeaveRequestCreator")
  leaveRequestsApproved LeaveRequest[]         @relation("LeaveRequestApprover")
  overtimeRequests      OvertimeRequest[]      @relation("OvertimeRequestCreator")
  overtimeApprovals     OvertimeRequest[]      @relation("OvertimeRequestApprover")
  compensationBalance   CompensationBalance?
  attendances           Attendance[]
  holidaysCreated       Holiday[]

  @@map("users")
}

model Department {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  code       String   @unique
  managerId  String   @db.Uuid
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  manager             User                 @relation("DepartmentManager", fields: [managerId], references: [id])
  departmentEmployees DepartmentEmployee[]
  policyConditions    PolicyCondition[]

  @@map("departments")
}

model DepartmentEmployee {
  departmentId String @db.Uuid
  employeeId   String @db.Uuid

  // Relations
  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  employee   User       @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@id([departmentId, employeeId])
  @@map("department_employees")
}

// ============================================
// LEAVE MANAGEMENT
// ============================================

model LeaveType {
  id                   String   @id @default(uuid()) @db.Uuid
  code                 String   @unique
  name                 String
  isPaid               Boolean  @default(false)
  deductCompensation   Boolean  @default(false)
  createdAt            DateTime @default(now())

  // Relations
  leaveRequests     LeaveRequest[]
  policies          Policy[]
  leavePolicyValues LeavePolicyValue[]

  @@map("leave_types")
}

model LeaveRequest {
  id          String    @id @default(uuid()) @db.Uuid
  leaveTypeId String    @db.Uuid
  status      String    // DRAFT | PENDING | APPROVED | REJECTED
  reason      String?
  fromDate    DateTime
  toDate      DateTime
  totalDays   Float
  createdBy   String    @db.Uuid
  createdAt   DateTime  @default(now())
  approvedBy  String?   @db.Uuid
  approvedAt  DateTime?

  // Relations
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
  creator   User      @relation("LeaveRequestCreator", fields: [createdBy], references: [id])
  approver  User?     @relation("LeaveRequestApprover", fields: [approvedBy], references: [id])

  @@index([createdBy])
  @@index([status])
  @@index([fromDate, toDate])
  @@map("leave_requests")
}

// ============================================
// OVERTIME MANAGEMENT
// ============================================

model OvertimeType {
  id                  String   @id @default(uuid()) @db.Uuid
  code                String   @unique
  name                String
  defaultMultiplier   Float
  isCompensation      Boolean  @default(false)
  createdAt           DateTime @default(now())

  // Relations
  overtimeRequests OvertimeRequest[]
  otPolicyValues   OTPolicyValue[]

  @@map("overtime_types")
}

model OvertimeRequest {
  id         String    @id @default(uuid()) @db.Uuid
  userId     String    @db.Uuid
  workDate   DateTime
  startTime  DateTime
  endTime    DateTime
  totalHours Float
  otTypeId   String    @db.Uuid
  reason     String?
  status     String    // PENDING | REJECTED | APPROVED | DRAFT
  approvedBy String?   @db.Uuid
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  user     User         @relation("OvertimeRequestCreator", fields: [userId], references: [id])
  otType   OvertimeType @relation(fields: [otTypeId], references: [id])
  approver User?        @relation("OvertimeRequestApprover", fields: [approvedBy], references: [id])

  @@index([userId])
  @@index([workDate])
  @@index([status])
  @@map("overtime_requests")
}

model CompensationBalance {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @db.Uuid
  hours     Float    @default(0)
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("compensation_balances")
}

// ============================================
// ATTENDANCE
// ============================================

model Attendance {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @db.Uuid
  workDate  DateTime
  checkIn   DateTime?
  checkOut  DateTime?
  status    String    // SCHEDULED | IN_PROGRESS | COMPLETED
  plan      String?
  result    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@unique([userId, workDate])
  @@index([userId, workDate])
  @@map("attendances")
}

// ============================================
// HOLIDAYS
// ============================================

model Holiday {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  date        DateTime
  type        String   // FIXED | CUSTOM
  session     String   // FULL | MORNING | AFTERNOON
  isRecurring Boolean  @default(false)
  createdBy   String   @db.Uuid
  createdAt   DateTime @default(now())

  // Relations
  creator User @relation(fields: [createdBy], references: [id])

  @@index([date])
  @@map("holidays")
}

// ============================================
// POLICY ENGINE
// ============================================

model Policy {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  type        String  // LEAVE | OT
  priority    Int
  isActive    Boolean @default(true)
  leaveTypeId String? @db.Uuid

  // Relations
  leaveType         LeaveType?          @relation(fields: [leaveTypeId], references: [id])
  conditions        PolicyCondition[]
  leavePolicyValues LeavePolicyValue[]
  otPolicyValues    OTPolicyValue[]

  @@map("policies")
}

model PolicyCondition {
  id           String  @id @default(uuid()) @db.Uuid
  policyId     String  @db.Uuid
  minYear      Int?
  maxYear      Int?
  departmentId String? @db.Uuid
  role         String? // EMPLOYEE | DEPARTMENT_HEAD | HR | DIRECTOR

  // Relations
  policy     Policy      @relation(fields: [policyId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])

  @@map("policy_conditions")
}

model LeavePolicyValue {
  id                   String  @id @default(uuid()) @db.Uuid
  policyId             String  @db.Uuid
  leaveTypeId          String  @db.Uuid
  maxDaysPerRequest    Float
  minimumNoticeDays    Int
  allowNegativeBalance Boolean @default(false)

  // Relations
  policy    Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@map("leave_policy_values")
}

model OTPolicyValue {
  id               String @id @default(uuid()) @db.Uuid
  policyId         String @db.Uuid
  otTypeId         String @db.Uuid
  maxHoursPerDay   Float
  salaryMultiplier Float

  // Relations
  policy Policy       @relation(fields: [policyId], references: [id], onDelete: Cascade)
  otType OvertimeType @relation(fields: [otTypeId], references: [id])

  @@map("ot_policy_values")
}
